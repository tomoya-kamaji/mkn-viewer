---
description: 編集したファイルに対して適切な粒度でコミット分割、GitHub PRを自動作成
---

## Description

このコマンドは編集したフォルダ配下にて、以下の作業を自動で実行します：

1. 変更内容を適切な粒度でコミットに分割
2. GitHub PRを作成
3. GitHub PRコメントには、目的と変更内容を記載
4. 複雑処理や新規処理がある場合はシーケンス図を用意

**使用例:** `/create-pr` → 自動でPR作成完了

## Implementation

### 0. ブランチの確認と作成

**重要:** コミット前に現在のブランチを確認し、mainブランチの場合は新しいブランチを作成します。

```bash
# 現在のブランチを確認
CURRENT_BRANCH=$(git branch --show-current)

# mainブランチの場合は警告して新しいブランチを作成
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "⚠️ 警告: mainブランチにいます。新しいブランチを作成します。"

  # 変更内容からブランチ名を推測（変更ファイルのパスや内容から）
  # 例: src/features/video-workflow の変更 → feat/video-workflow
  # デフォルトはタイムスタンプベース
  BRANCH_NAME="feat/$(date +%Y%m%d-%H%M%S)"

  # 新しいブランチを作成して切り替え
  git checkout -b "$BRANCH_NAME"
  echo "✅ ブランチ '$BRANCH_NAME' を作成しました"
else
  echo "✅ 現在のブランチ: $CURRENT_BRANCH"
fi
```

**ブランチ名の生成方針:**

- 変更内容から適切なプレフィックス（feat/fix/refactor等）を推測
- 変更ファイルのパスから機能名を抽出
- 推測できない場合はタイムスタンプベースの名前を使用

### 1. 変更ファイルの確認と除外処理

まず、現在の変更状況を確認し、除外すべきファイルをチェック：

```bash
git status
git diff --name-only
```

**自動除外対象:**

- `.vscode/` 配下の全ファイル
- `.idea/` 配下の全ファイル
- その他IDEやツール設定ファイル

これらのファイルが変更されている場合：

1. ユーザーに確認メッセージを表示
2. 自動的に `git restore` で変更を破棄（または除外）
3. 除外したファイル一覧を表示

### 2. セキュリティチェック（環境変数・機密情報）

**必須チェック項目:**

コミット前に以下のパターンを検索し、該当する場合は警告：

```bash
# 環境変数ファイル
.env
.env.local
.env.production
credentials.json
secrets.yaml

# 機密情報パターン
API_KEY=
SECRET_KEY=
PASSWORD=
TOKEN=
PRIVATE_KEY=
AWS_ACCESS_KEY_ID=
DATABASE_URL=
```

**検出時の動作:**

1. 該当ファイルとマッチした行を表示
2. 「⚠️ 警告: 機密情報が含まれている可能性があります」と表示
3. ユーザーに確認を求める：
   - 続行する場合: コミットから該当ファイルを除外
   - 中止する場合: 処理を終了
4. 誤検出の場合: ユーザーが明示的に承認

**セキュリティチェックのコード例:**

```bash
# 環境変数ファイルのチェック
git diff --cached --name-only | grep -E '\.(env|credentials|secrets)'

# 機密情報パターンのチェック
git diff --cached | grep -iE '(api_key|secret|password|token|private_key).*=.*[a-zA-Z0-9]{8,}'
```

### 4. 変更内容の分析

`git diff` と `git status` で以下を確認：

- 変更されたファイルの種類と役割
- 変更の目的と関連性
- 適切なコミット粒度の判断

**除外ファイルは分析対象外。**

### 5. コミットの分割と作成

変更内容を論理的な単位で分割してコミット：

**コミット粒度の例:**

- 型定義の追加/変更
- 新規メソッドの追加
- 既存メソッドのリファクタリング
- テストの追加
- ドキュメントの更新

**コミットメッセージフォーマット:**

```
<type>: <subject>

<body>

🤖 Generated with Cursor
```

**type の種類:**

- `feat`: 新機能
- `fix`: バグ修正
- `refactor`: リファクタリング
- `docs`: ドキュメント
- `style`: コードフォーマット
- `test`: テスト追加
- `chore`: その他の変更

### 6. PR作成

**全てのチェックをパスし、コミットが完了した後**、`gh pr create` コマンドでPRを作成：

```bash
gh pr create --title "タイトル" --body "$(cat <<'EOF'
## 📝 概要
変更の目的と背景を簡潔に説明

## 🔧 変更内容
- 主要な変更点1
- 主要な変更点2
- 主要な変更点3

## 🎯 影響範囲
- 影響を受けるファイル・機能
- 破壊的変更の有無

## 📊 シーケンス図（複雑な処理の場合）
\`\`\`mermaid
sequenceDiagram
    participant A
    participant B
    A->>B: 処理フロー
\`\`\`

## ✅ テスト
- [ ] ローカルでの動作確認
- [ ] 型チェック通過

🤖 Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

### 7. 出力

PR作成後、以下を出力：

- ✅ セキュリティチェック結果
- 🚫 除外されたファイル一覧
- 📝 作成されたコミット一覧
- 🔗 PR URL
- 📊 変更ファイルサマリー

## 実行フロー

### ステップバイステップ

0. **ブランチの確認と作成** ⚠️ **重要**
   - 現在のブランチを確認
   - mainブランチの場合は新しいブランチを作成して切り替え
   - これによりmainブランチへの直接コミットを防止

1. **変更ファイルの確認**
   - `git status` で変更ファイルを確認
   - `.claude/`, `.cursor/` などの除外対象を検出

2. **セキュリティチェック** ⚠️ **重要**
   - 環境変数ファイル（.env等）の検出
   - 機密情報パターン（API_KEY等）の検出
   - 検出時は警告表示とユーザー確認

3. **除外ファイルの処理**
   - 除外対象ファイルを `git restore` または無視
   - 除外ファイル一覧を表示

4. **変更内容の分析**
   - 変更内容を分析し、適切な粒度でコミットに分割

5. **コミット作成**
   - 各コミットを作成（コミットメッセージは日本語で簡潔に）

6. **PR作成**
   - PRタイトルとボディを生成
   - 複雑な処理がある場合はMermaid図を自動生成
   - `gh pr create` でPR作成

7. **結果出力**
   - PR URLと作成サマリーを出力

## 注意事項

### セキュリティ関連 🔒

- **環境変数ファイルは絶対にコミットしない**
- 機密情報パターンが検出された場合は必ず確認
- 誤検出の場合も慎重に判断
- 除外ファイル（.claude/, .cursor/）は自動で除外

### コミット関連 📝

- コミットは論理的な単位で分割（1コミット1責務）
- コミットメッセージは分かりやすく
- PRの説明は変更内容が一目で分かるように
- 複雑な処理フローがある場合は必ずシーケンス図を追加

### エラー処理 ⚠️

- ブランチ作成に失敗した場合は処理を中断
- セキュリティチェックで問題が見つかった場合は処理を中断
- 除外ファイルのみの変更の場合は警告を表示
- mainブランチにコミットしようとした場合は警告を表示して処理を中断
